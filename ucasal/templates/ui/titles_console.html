{% extends "ui/base.html" %}
{% block content %}
<div class="card shadow-sm mb-3">
  <div class="card-header d-flex align-items-center"><i class="bi bi-terminal me-2"></i><strong>Consola de Títulos (Athento)</strong></div>
  <div class="card-body">
    <div class="row g-3">
      <div class="col-lg-3">
        <label class="form-label">Acción</label>
        <select id="cmdAction" class="form-select">
          <option value="search">search</option>
          <option value="resultset">resultset</option>
          <option value="list">list</option>
          <option value="get">get</option>
          <option value="download">download</option>
          <option value="create">create</option>
          <option value="update">update</option>
          <option value="delete">delete</option>
        </select>
      </div>
      <div class="col-lg-9">
        <label class="form-label">Payload JSON</label>
        <textarea id="cmdPayload" class="form-control" rows="10" placeholder='{"query":"SELECT * FROM form_titulo"}'></textarea>
        <div class="form-text">Incluye solo los campos necesarios para la acción elegida. El campo "action" se completa automáticamente.</div>
      </div>
    </div>
    <div class="row g-3 mt-1">
      <div class="col-lg-6">
        <label class="form-label">Archivo (opcional para create/update)</label>
        <input id="cmdFile" class="form-control" type="file" />
        <div class="form-text">Tipos permitidos: pdf, png, jpg, jpeg. Máximo 20 MB.</div>
      </div>
      <div class="col-lg-6">
        <label class="form-label">Nombre de archivo (si difiere del seleccionado)</label>
        <input id="cmdFilename" class="form-control" type="text" placeholder="ej: documento.pdf" />
      </div>
    </div>
    <div class="mt-3 d-flex gap-2">
      <button id="btnRun" class="btn btn-primary"><i class="bi bi-play"></i> Ejecutar</button>
      <button id="btnCopy" class="btn btn-outline-secondary"><i class="bi bi-clipboard"></i> Copiar resultado</button>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header d-flex align-items-center"><i class="bi bi-box-arrow-down me-2"></i><strong>Resultado</strong></div>
  <div class="card-body">
    <pre id="cmdResult" class="bg-light p-2 border rounded" style="max-height: 520px; overflow:auto">--</pre>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  function show(obj){
    document.getElementById('cmdResult').textContent = typeof obj === 'string' ? obj : JSON.stringify(obj, null, 2);
  }
  const MAX_SIZE = 20 * 1024 * 1024; // 20 MB
  const ALLOWED = ['application/pdf','image/png','image/jpeg'];

  function fileToBase64(file){
    return new Promise((resolve, reject)=>{
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const dataUrl = reader.result || '';
          const parts = String(dataUrl).split('base64,');
          const b64 = parts.length > 1 ? parts[1] : '';
          resolve(b64);
        } catch (e) { reject(e); }
      };
      reader.onerror = () => reject(reader.error || new Error('No se pudo leer el archivo'));
      reader.readAsDataURL(file);
    });
  }

  document.getElementById('btnRun').addEventListener('click', async function(){
    const action = document.getElementById('cmdAction').value;
    let payload = {};
    try{
      const raw = document.getElementById('cmdPayload').value.trim();
      payload = raw ? JSON.parse(raw) : {};
    }catch(e){ return show({ error: 'Payload JSON inválido' }); }
    payload.action = action;
    try{
      // Adjuntar archivo automáticamente para create/update si fue elegido
      if ((action === 'create' || action === 'update')){
        const inp = document.getElementById('cmdFile');
        const file = inp && inp.files && inp.files[0];
        if (file){
          if (file.size > MAX_SIZE) { return show({ error: `El archivo supera el máximo permitido (${(MAX_SIZE/1024/1024)} MB)` }); }
          if (ALLOWED.indexOf(file.type) === -1) { return show({ error: `Tipo no permitido: ${file.type}` }); }
          const filenameOverride = document.getElementById('cmdFilename').value.trim();
          if (!payload.filename) { payload.filename = filenameOverride || file.name; }
          if (!payload.file_base64) { payload.file_base64 = await fileToBase64(file); }
        }
      }
      const resp = await fetch('/api/titulos/command', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const data = await resp.json();
      show({ status: resp.status, ...data });
    }catch(e){ show({ error: String(e) }); }
  });
  document.getElementById('btnCopy').addEventListener('click', function(){
    const txt = document.getElementById('cmdResult').textContent || '';
    navigator.clipboard.writeText(txt);
  });
})();
</script>
{% endblock %}
