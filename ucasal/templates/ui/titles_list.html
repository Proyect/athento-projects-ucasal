{% extends "ui/base.html" %}
{% block content %}
<div class="card shadow-sm mb-3">
  <div class="card-header"><i class="bi bi-search me-2"></i><strong>Búsqueda</strong></div>
  <div class="card-body">
    <form id="searchForm" method="post">
      {% csrf_token %}
      <div class="row g-2 align-items-center">
        <div class="col-md-10">
          <input class="form-control" name="query" placeholder="Consulta SELECT..." value="{{ query }}" />
          <div class="form-text">Ej.: SELECT uuid, filename FROM form_titulo</div>
        </div>
        <div class="col-md-2 d-grid">
          <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i> Buscar</button>
        </div>
      </div>
    </form>
    <div id="search-error" class="alert alert-danger mt-3 d-none">
      <i class="bi bi-exclamation-triangle me-1"></i>
      <span id="search-error-text"></span>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="card-header d-flex align-items-center"><i class="bi bi-list-ul me-2"></i><strong>Resultados</strong></div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table id="titlesTable" class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th style="width:28%">UUID</th>
            <th style="width:28%">Filename</th>
            <th style="width:14%">Estado</th>
            <th style="width:14%">Creación</th>
            <th style="width:16%">Autor</th>
            <th style="width:220px">Acciones</th>
          </tr>
        </thead>
        <tbody>
        {% for item in items %}
          <tr>
            <td><code class="small">{{ item.uuid }}</code></td>
            <td>{{ item.filename }}</td>
            <td class="text-nowrap"><span class="badge bg-secondary">{{ item.estado }}</span></td>
            <td class="text-nowrap">{{ item.created }}</td>
            <td class="text-truncate" style="max-width:200px">{{ item.author }}</td>
            <td>
              <a class="btn btn-sm btn-outline-primary" href="/ui/titulos/{{ item.uuid }}/"><i class="bi bi-eye" data-label="Ver"></i> </a>
              <a class="btn btn-sm btn-outline-secondary" href="/athento/files/{{ item.uuid }}/download"><i class="bi bi-download" data-label="Descargar"></i> </a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="6" class="text-muted p-3">Sin resultados</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function(){
    if (window.jQuery && $('#titlesTable').length) {
      const $table = $('#titlesTable');
      const initialQuery = encodeURIComponent('{{ query|default:"" }}');
      const errorBox = document.getElementById('search-error');
      const errorText = document.getElementById('search-error-text');

      function setSearchError(message) {
        if (!errorBox || !errorText) {
          return;
        }
        if (message) {
          errorText.textContent = message;
          errorBox.classList.remove('d-none');
        } else {
          errorText.textContent = '';
          errorBox.classList.add('d-none');
        }
      }

      const table = $table.DataTable({
        pageLength: 20,
        lengthMenu: [10,20,50,100],
        order: [],
        columnDefs: [ { targets: -1, orderable: false, searchable: false } ],
        language: { url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json' },
        dom: 'Bfrtip',
        buttons: [
          { extend: 'copy', text: 'Copiar' },
          { extend: 'csv', text: 'CSV' },
          { extend: 'excel', text: 'Excel' },
          { extend: 'pdf', text: 'PDF' },
          { extend: 'print', text: 'Imprimir' },
          { extend: 'colvis', text: 'Columnas' }
        ],
        ajax: {
          url: '/ui/api/titulos/' + (initialQuery ? ('?query=' + initialQuery) : ''),
          dataSrc: function(json) {
            if (json && json.error) {
              setSearchError(json.error);
            } else {
              setSearchError(null);
            }
            return (json && json.data) ? json.data : [];
          },
          error: function(xhr) {
            var message = 'Error inesperado consultando títulos';
            if (xhr && xhr.responseText) {
              try {
                var parsed = JSON.parse(xhr.responseText);
                if (parsed && parsed.error) {
                  message = parsed.error;
                }
              } catch (e) {
                // ignorar error de parseo y usar mensaje genérico
              }
            }
            setSearchError(message);
          }
        },
        columns: [
          { data: 'uuid', render: function(data){ return '<code class="small">'+(data||'')+'</code>'; } },
          { data: 'filename' },
          { data: 'estado', render: function(d){ return d ? '<span class="badge bg-secondary">'+d+'</span>' : ''; } },
          { data: 'created' },
          { data: 'author' },
          { data: 'acciones', orderable:false, searchable:false }
        ]
      });

      // Interceptar submit del formulario para recargar por AJAX
      const form = document.getElementById('searchForm');
      form.addEventListener('submit', function(ev){
        ev.preventDefault();
        const q = (form.query && form.query.value) ? encodeURIComponent(form.query.value) : '';
        const url = '/ui/api/titulos/' + (q ? ('?query=' + q) : '');
        table.ajax.url(url).load();
      });
    }
  });
</script>
{% endblock %}
